let co2Initialized = false;
let co2CartUpdate = false;
const priceFormatter = new Intl.NumberFormat('de-DE', {
  style: 'currency',
  currency: 'EUR'
});

const applyDatoraDiscount = async function() {
  const datoraInput = document.querySelector('input[name="datora-discount"][form="datora-form"]') || 
                     document.querySelector('input[name="datora-discount"]');
  if(!datoraInput) return;
  const discountCode = datoraInput.value.trim();
  const datoraContainer = datoraInput.closest('.datora-discount-field-container');
  if(discountCode.length < 1) {
    return;
  }
  if(datoraContainer) datoraContainer.classList.add('loading');
  if (typeof co2 !== 'undefined' && typeof co2.setDiscountCode === 'function') {
    let resultChangeDiscountCode = await co2.setDiscountCode(discountCode);
    if(resultChangeDiscountCode){
      if(datoraContainer){
        datoraContainer.classList.add('done');
        datoraContainer.classList.remove('error', 'loading');
      }
      document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
    } else {
      if(datoraContainer){
        datoraContainer.classList.add('error');
        datoraContainer.classList.remove('done', 'loading');
      }
    }
  }
};

const removeDatoraDiscount = async function() {
  const datoraCodeContainer = document.querySelector('.datora-discount-field-container');
  const datoraCodeApplied = datoraCodeContainer.querySelectorAll('.applied-discount');
  if (typeof co2 !== 'undefined' && typeof co2.removeDiscountCode === 'function') {
    datoraCodeApplied.forEach(element => {
      const buttonsInElement = element.querySelectorAll('button');
      buttonsInElement.forEach(button => {
          button.disabled = true;
      });
    });

    let resultRemoveDiscountCode = await co2.removeDiscountCode();
    if(resultRemoveDiscountCode){
      document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));

      const datoraInput = document.querySelector('input[name="datora-discount"][form="datora-form"]') || 
                          document.querySelector('input[name="datora-discount"]');
      if (datoraInput) datoraInput.value = '';

      const datoraContainer = datoraInput?.closest('.datora-discount-field-container');
      if (datoraContainer) {
        datoraContainer.classList.remove('error', 'done', 'loading');
      }

      document.querySelectorAll('.price--highlight').forEach(elem => {
        elem.classList.remove('price--highlight');
      });

      datoraCodeApplied[0].disabled = false;

    }else{ datoraCodeApplied[0].disabled = false; }
  }
}

function setDatoraClasses(parentElem, fakeComparePrice) {
  parentElem.querySelectorAll('[data-datora-classes]').forEach(elem => {
    const newClasses = elem.dataset.datoraClasses;

    if(newClasses.length === 0) {
      return;
    }

    if(newClasses.includes('price--compare')) {
      elem.querySelector('span:not(.visually-hidden)').textContent = fakeComparePrice;
    }

    elem.setAttribute('class', newClasses);
  });
}

function updateProductGridDiscounts() {
  if (typeof co2 === 'undefined' || typeof co2.getDiscountCode !== 'function') {
    return;
  }
  
  co2.getDiscountCode().then(code => {
    document.querySelectorAll('[data-datora-pid]').forEach(div => {
      const [vid, pid, spgid, tags, price] = [
        div.dataset.datoraVid,
        div.dataset.datoraPid,
        div.dataset.datoraSpgid,
        div.dataset.datoraTags,
        div.dataset.datoraPrice
      ];

      console.log("updateProductGridDiscounts",vid, pid, spgid, tags, price);

      if (!(vid && pid && price)) return;

      co2.itemDiscountFull(Number(pid), Number(vid), tags ? tags.split(',') : [], Number(price), 1, spgid === "" ? null : spgid)
        .then(data => {
          const basePriceFormatted = priceFormatter.format(price / 100);

          if (data.calc === "perc" && data.discPerc > 0) {
            const discountedPrice = price - price * data.discPerc / 100;
            const newPrice = priceFormatter.format(discountedPrice / 100);

            div.querySelector('.price-list .price:not(.price--compare) span:not(.visually-hidden)').textContent = newPrice;

            const originalPriceAsComparePrice = priceFormatter.format(price / 100);
            setDatoraClasses(div, originalPriceAsComparePrice);

            const discountValue = price * data.discPerc / 100;
            const formattedDiscountValue = priceFormatter.format(discountValue / 100);

            div.querySelector('[data-datora]').innerHTML = `-${data.discPerc}% (${formattedDiscountValue}) ${code.toUpperCase()}`;

            const badge = div.querySelector('.datora.discount-badge');
            if (badge) badge.removeAttribute('hidden');

          } else if (data.calc === "amt" && data.discAmt > 0) {
            const discountedPrice = price - data.discAmt * 100;
            const newPrice = priceFormatter.format(discountedPrice / 100);
            
            div.querySelector('.price-list .price:not(.price--compare) span:not(.visually-hidden)').textContent = newPrice;
            
            const originalPriceAsComparePrice = priceFormatter.format(price / 100);
            setDatoraClasses(div, originalPriceAsComparePrice);
            
            const discountValue = price - discountedPrice;
            const formattedDiscountValue = priceFormatter.format(discountValue / 100);
            
            div.querySelector('[data-datora]').innerHTML = `(-${formattedDiscountValue}) ${code.toUpperCase()}`;
            
            const badge = div.querySelector('.datora.discount-badge');
            if (badge) badge.removeAttribute('hidden');
          } else {
            div.querySelector('.price-list .price:not(.price--compare) span:not(.visually-hidden)').textContent = basePriceFormatted;

            const comparePriceElem = div.querySelector('.price--compare');
            if (comparePriceElem) {
              comparePriceElem.classList.add('visually-hidden');
            }

            const datoraInfo = div.querySelector('[data-datora]');
            if (datoraInfo) datoraInfo.textContent = '';

            const badge = div.querySelector('.datora.discount-badge');
            if (badge) badge.setAttribute('hidden', true);
          }
        }).catch(() => {});
    });
  }).catch(() => {});
}


window.addEventListener('co2.cart.initialized', function() {
  if(!co2Initialized){
    updateProductGridDiscounts();
    console.log("EventListener: co2.cart.initialized");
    co2Initialized = true;
  }
});

window.addEventListener('co2.codelink', function(event){
  updateProductGridDiscounts();
  console.log("EventListener: co2.codelink");
});

window.addEventListener('co2.discountCodeSet', function(event){
  updateProductGridDiscounts();
  console.log("EventListener: co2.discountCodeSet");
});

document.documentElement.addEventListener('cart:refresh', () => {
  if(co2Initialized && co2CartUpdate){
    updateProductGridDiscounts();
    console.log("EventListener: cart:refresh");
  }else{
    co2CartUpdate = true;
  }
});